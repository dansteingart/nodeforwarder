<html>
    <head>
        <script src="/static/js/jquery-3.6.0.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            body{font-family: Helvetica,Arial, sans-serif;}
            img{width:100%}
            input{outline: none; border:none;border-bottom: 1px solid black;text-align: right;width:50px;}
            textarea{outline: none; border: 1px solid black;text-align: left;width:50px;  resize:vertical;height:300px}
            .img{float:right;width:75%}
            .meta{width:200px;text-align:left}
            h2::selection{background: white;}
            .hider {visibility:hidden;}
            .shower {visibility:visible;}
            .terminal{
                background:black;
                color:green;
                white-space:pre-wrap;
                font-family: 'Courier New', Courier, monospace;
                
            }
            td{vertical-align: top;}

        </style>
    </head>
    <body>
        <h1>EnderScope 5000</h1>
        <div id="image" class="img"></div>


        <table>
            <tr><td>move x/y</td><td><input id='movexy' value=0.2> </input>mm</td></tr>
            <tr><td>move z</td><td><input id='movez' value=0.02> </input>mm</td></tr>
            <tr><td>X</td><td><input id='posX' value=1 readonly> </input>mm</td></tr>
            <tr><td>Y</td><td><input id='posY' value=1 readonly> </input>mm</td></tr>
            <tr><td>Z</td><td><input id='posZ' value=1 readonly> </input>mm</td></tr>
        </table>

        <h2 id="meta_head">Meta</h2>
        <div id="meta_table">
            <table>
                <tr><td>project</td><td><input id='project' class="meta"> </input></td></tr>
                <tr><td>prefix</td><td><input id='user' class="meta" value="snap"> </input></td></tr>
                <tr><td>user</td><td><input id='user' class="meta"> </input></td></tr>
                <tr><td>date/time</td><td><input id='datetime' class="meta" readonly> </input></td></tr>
                <tr><td>notes</td><td><textarea id='notes' class="meta"></textarea></td></tr>
                
            </table>
        </div>

        <h2 id="v42l_head">Camera Controls</h2>
        <div id="v4l2_table"></div>

        <h2 id="abs_move_head">Absolute Positioning</h2>
        <div id="abs_move_table">
        <table>
            <tr><td>X</td><td><input id='absmoveX'> </input>mm</td><td><button id="absmove">go</button></td></tr>
            <tr><td>Y</td><td><input id='absmoveY'> </input>mm</td></tr>
            <tr><td>Z</td><td><input id='absmoveZ'> </input>mm</td></tr>
        </table>
        </div>


        <h2 id="exec_head">Spooky Scary</h2>
        <div id = "exec_list">
            <input id="exec_in" style="width:200px;text-align:left;"></input><button id="exec_send">Send</button>
            <div id="exec_out" class="terminal"></div>
        </div>

    
    <script>
            surl = `http://${window.location.hostname}:${window.location.port}`
            curl = `http://${window.location.hostname}:8181`

            poslog = ""
            var socket = io();
            socket.on('data', (msg) => {
                poslog += msg
                pat = /(?=X)(.*?)(?=Count)/g
                last_pos = [...poslog.matchAll(pat)]
                a = new Date();
                $("#datetime").val(a.toLocaleString());
                if (last_pos.length > 0)
                {
                    parse_position(last_pos[last_pos.length-1][0])
                    poslog="";
                }
            })
 
            function parse_position(str)
            {
                parts = str.trim().split(" ")
                obj = {}
                for (p in parts) obj[parts[p].split(":")[0]] = parts[p].split(":")[1]
                if ($("#posX").val() != obj['X']) $("#posX").val(obj['X']).trigger("change");
                if ($("#posY").val() != obj['Y']) $("#posY").val(obj['Y']).trigger("change");
                if ($("#posZ").val() != obj['Z']) $("#posZ").val(obj['Z']).trigger("change");
                return obj

            }

            // functions for v4l2 stuffs
            function arb_exec(cmd){$.post(`/exec`,data={'payload':cmd})};

            v4l2_ctl = undefined
            kk = undefined
            function get_v4l2_ctl(){
                $.post(`/run`,
                        data={'payload':"v4l2-ctl -l"},
                        (data)=>{
                            v4l2_ctl = parse_v4l2_controls(data['stdout']);
                            v4l2_tab = make_v4l2_table(v4l2_ctl);
                            $("#v4l2_table").html(v4l2_tab);
                            $("#v4l2_table").toggle();
                            $('input[attr=v4l2_cntl]').change((ev)=>
                            {
                               cmd = `v4l2-ctl -d /dev/video0 -c ${ev.target.id.replace("#","")}=${ev.target.value}` 
                               arb_exec(cmd)
                            })
                            }
                        )
                    };

            function parse_v4l2_controls(str)
            {
                cntls = str.trim().split("\n")
                obj = {}
                for (c in cntls)
                {
                    cntl = cntls[c].trim().split(":")
                    name = cntl[0].split(" ")[0]
                    obj[name] = {}
                    obj[name]['hex']  = cntl[0].split(" ")[1]
                    obj[name]['type'] = cntl[0].split(" ")[2]
                    for (a in cntl[1].trim().split(" "))
                    {
                        aa = cntl[1].trim().split(" ")[a].split("=");
                        obj[name][aa[0]]=aa[1]
                    }
                }
                return obj
            }

            function make_v4l2_table(obj){
                out = "<table style='visibility:inherit;'>"
                for (key in obj)
                {
                    out+=`<tr><td>${key}</td><td><input attr='v4l2_cntl' id='#${key}' value='${obj[key]['value']}'></td></tr>`
                }
                out+="</table>"
                return out

            }

            $("#v42l_head").click(()=>{$("#v4l2_table").toggle()})
            
            $("#exec_head").click(()=>{$("#exec_list").toggle()})
            
            $("#abs_move_head").click(()=>{$("#abs_move_table").toggle()})

            $("#absmove").click(() =>
                {
                    x = parseFloat($("#absmoveX").val())
                    y = parseFloat($("#absmoveY").val())
                    z = parseFloat($("#absmoveZ").val())
                    absmove(x,y,z)
                }
            )

            //Let's execute arbirary code!
            $("#exec_send").click(()=>{arb_exec($("#exec_in").val())})
            socket.on('exec',(msg) =>{$("#exec_out").html(msg)});

            //stage control
            function move(x,y,z)
            {
                out = `G91\nG0 F2000 X${x} Y${y} Z${z}`
                $.post(`/write`,data={'payload':`${out}\n`})
            }

            function absmove(x,y,z)
            {
                out = `G90\nG0 F2000 X${x} Y${y} Z${z}`
                $.post(`/write`,data={'payload':`${out}\n`})
            }

            function get_position(){$.post(`/write`,data={'payload':'M114\n'})}
            
            function steppers_off(){$.get(`/writecf/M18 X Y Z`)}

            $(window).keydown((e)=>{
                zz = parseFloat($("#movez").val())
                xy = parseFloat($("#movexy").val())

                if ($("input").is(":focus") == false & $("textarea").is(":focus") == false)
                {
                    switch(e.originalEvent.keyCode)
                    {
                        case 37: move(-1*xy,0,0); break;
                        case 39: move(1*xy,0,0);break;
                        case 38: move(0,1*xy,0);break;
                        case 40: move(0,-1*xy,0);break;
                        case 87: move(0,0,zz);break;
                        case 83: move(0,0,-1*zz);break;
                        case 77: get_position();break;
                        case 79: steppers_off();break;
                    }
                }

            })


            //on load

            $("#image").html(`<img src="${curl}/.?action=stream">`)

            //reset camera
            arb_exec(`
            v4l2-ctl -d /dev/video0 -c exposure_auto=1;
            v4l2-ctl -c white_balance_temperature_auto=1;
            v4l2-ctl -c gamma=100`)
            //get controls
            get_v4l2_ctl();
            $("#abs_move_table").toggle();
            //hide spooky scary
            $("#exec_head").toggle()
            $("#exec_list").toggle()

            $("#posX").change((ev)=>{$("#absmoveX").val($("#posX").val())})
            $("#posY").change((ev)=>{$("#absmoveY").val($("#posY").val())})
            $("#posZ").change((ev)=>{$("#absmoveZ").val($("#posZ").val())})

        </script>

    </body>

</html>